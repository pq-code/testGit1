#!/usr/bin/env bash

while read oldrev newrev refname; do
  branch=$(git rev-parse --symbolic --abbrev-ref $refname)

  # 检查是否是 test 分支
  if [ "$branch" != "test" ]; then
    # 检查是否是合并操作
    if [ "$(git cat-file -t $newrev)" = "commit" ] && [ "$(git cat-file -t $oldrev)" = "commit" ]; then
      # 获取合并的源分支
      source_branch=$(git merge-base $oldrev $newrev)
      # 检查源分支是否是 test 分支
      if [ "$source_branch" = "$oldrev" ]; then
        echo "Cannot merge from test branch to $branch."
        exit 1
      fi
    fi
  fi
done
